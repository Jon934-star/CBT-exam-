<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHM 101 Mock CBT Exam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- ALL CUSTOM CSS INCLUDED HERE FOR GITHUB HOSTING -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            -webkit-tap-highlight-color: transparent;
        }

        /* Prevent text selection for CBT feel */
        .no-select {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* Custom Scrollbar for a premium look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Grid Button States */
        .q-nav-btn {
            transition: all 0.2s ease;
        }
        .q-nav-btn.answered {
            background-color: #10b981; 
            color: white;
            border-color: #10b981;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }
        .q-nav-btn.active {
            box-shadow: 0 0 0 2px #3b82f6; 
            background-color: #dbeafe; 
            color: #1e3a8a;
            border-color: #3b82f6;
            transform: scale(1.05);
        }

        /* Smooth fade animations */
        .fade-in {
            animation: fadeIn 0.4s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Input focus effects */
        .input-field:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800 no-select">

    <!-- Top Header -->
    <header class="bg-blue-800 text-white p-3 md:p-4 shadow-lg flex justify-between items-center z-20 shrink-0 border-b border-blue-900">
        <div class="flex items-center gap-3">
            <div class="bg-blue-700 p-2 rounded-lg hidden md:block">
                <i class="fas fa-flask text-blue-300 text-xl"></i>
            </div>
            <div>
                <h1 class="text-lg md:text-2xl font-bold tracking-tight">CHM 101 CBT</h1>
                <p class="text-xs md:text-sm text-blue-200 font-medium">Department of Chemistry</p>
            </div>
        </div>
        <div id="header-user-info" class="hidden md:flex items-center gap-3 text-sm font-medium text-blue-100 bg-blue-900 px-4 py-2 rounded-full">
            <i class="fas fa-user-graduate"></i> <span id="display-name">Student</span>
        </div>
        <div id="timer-display" class="hidden bg-white text-blue-900 px-3 py-1.5 md:px-5 md:py-2 rounded-lg text-lg md:text-xl font-mono font-black shadow-inner flex items-center border-2 border-blue-200 transition-colors">
            <i class="fas fa-clock mr-2 text-blue-500"></i><span id="time-left">40:00</span>
        </div>
    </header>

    <!-- Login / Authentication Screen -->
    <main id="login-screen" class="flex-1 flex items-center justify-center p-4 overflow-y-auto fade-in">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-10 max-w-md w-full border border-gray-100">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-blue-100">
                    <i class="fas fa-university text-4xl text-blue-600"></i>
                </div>
                <h2 class="text-2xl font-extrabold text-gray-900">Student Portal</h2>
                <p class="text-gray-500 text-sm mt-2">Enter your details to access the mock CBT.</p>
            </div>

            <form id="login-form" class="space-y-5">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Full Name</label>
                    <div class="relative">
                        <i class="fas fa-user absolute left-4 top-3.5 text-gray-400"></i>
                        <input type="text" id="student-name" required placeholder="odamah Jonathan" class="input-field w-full bg-gray-50 border border-gray-300 text-gray-900 rounded-xl py-3 px-10 transition">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Department</label>
                    <div class="relative">
                        <i class="fas fa-building absolute left-4 top-3.5 text-gray-400"></i>
                        <input type="text" id="student-dept" required placeholder="Medicine and Surgery" class="input-field w-full bg-gray-50 border border-gray-300 text-gray-900 rounded-xl py-3 px-10 transition">
                    </div>
                </div>
                <div class="pt-4">
                    <button type="submit" id="auth-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl transition shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        Authenticate & Continue <i class="fas fa-sign-in-alt ml-2"></i>
                    </button>
                </div>
            </form>
            <p class="text-xs text-center text-gray-400 mt-6"><i class="fas fa-shield-alt mr-1"></i> Device tracking enabled via Local Storage.</p>
        </div>
    </main>

    <!-- Dashboard / Start Screen -->
    <main id="start-screen" class="hidden flex-1 items-center justify-center p-4 overflow-y-auto fade-in">
        <div class="bg-white rounded-3xl shadow-xl p-6 md:p-10 max-w-2xl w-full text-center border border-gray-100">
            <h2 class="text-3xl md:text-4xl font-black mb-2 text-gray-900">Welcome, <span id="dash-name" class="text-blue-600">Student</span>!</h2>
            <p class="text-gray-500 font-medium mb-8 bg-gray-50 py-2 px-4 rounded-full inline-block"><i class="fas fa-building mr-2 text-gray-400"></i><span id="dash-dept">Department</span></p>
            
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg text-left mb-8">
                <h3 class="font-bold text-blue-900 mb-1"><i class="fas fa-info-circle mr-2"></i>Exam Instructions</h3>
                <ul class="text-sm text-blue-800 space-y-1 ml-6 list-disc">
                    <li>Database connected! You will face exactly <strong>70 randomized questions</strong>.</li>
                    <li>You have a strict <strong>40-minute</strong> time limit.</li>
                    <li>The system will auto-submit when the timer hits zero.</li>
                </ul>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-8 max-w-md mx-auto">
                <div class="bg-white p-4 rounded-2xl border-2 border-gray-100 shadow-sm">
                    <i class="fas fa-hourglass-half text-2xl text-orange-500 mb-2"></i>
                    <p class="text-xs text-gray-500 uppercase font-bold">Duration</p>
                    <p class="text-xl font-black text-gray-800">40 Mins</p>
                </div>
                <div class="bg-white p-4 rounded-2xl border-2 border-gray-100 shadow-sm">
                    <i class="fas fa-list-ol text-2xl text-green-500 mb-2"></i>
                    <p class="text-xs text-gray-500 uppercase font-bold">Questions</p>
                    <p class="text-xl font-black text-gray-800">70</p>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button onclick="logout()" class="px-6 py-3 font-bold text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl transition">
                    Not you? Logout
                </button>
                <button onclick="startExam()" id="start-exam-btn" disabled class="bg-gray-400 text-white font-bold py-3 px-10 rounded-xl transition shadow-lg flex items-center justify-center disabled:cursor-not-allowed">
                    <i class="fas fa-spinner fa-spin mr-2" id="loading-spinner"></i> <span id="start-btn-text">Loading Questions...</span>
                </button>
            </div>
        </div>
    </main>

    <!-- Exam Interface -->
    <main id="exam-screen" class="hidden flex-1 overflow-hidden relative fade-in">
        <!-- Question Area -->
        <section class="flex-1 flex flex-col bg-white overflow-hidden w-full h-full relative z-10 rounded-tl-2xl md:rounded-tl-none border-t md:border-t-0 border-gray-200 shadow-[-5px_0_15px_rgba(0,0,0,0.02)]">
            <div class="p-5 md:p-10 overflow-y-auto flex-1 pb-24 md:pb-10">
                <div class="mb-6 flex flex-col md:flex-row md:justify-between md:items-end border-b-2 border-gray-100 pb-4 gap-3">
                    <div>
                        <span id="topic-badge" class="bg-blue-100 text-blue-800 text-[10px] uppercase tracking-wider px-3 py-1.5 rounded-md font-bold inline-block w-max mb-2">Topic</span>
                        <h2 class="text-xl md:text-2xl font-black text-gray-800">Question <span id="current-q-num" class="text-blue-600">1</span> <span class="text-gray-400 text-lg">/ 70</span></h2>
                    </div>
                </div>
                
                <div class="text-lg md:text-2xl text-gray-800 mb-8 leading-relaxed font-medium" id="question-text">
                    Loading question...
                </div>

                <div id="options-container" class="space-y-3 max-w-4xl">
                    <!-- Options injected via JS -->
                </div>
            </div>

            <!-- Bottom Navigation -->
            <div class="bg-white border-t border-gray-200 p-4 md:p-6 flex justify-between items-center shrink-0 shadow-[0_-5px_15px_rgba(0,0,0,0.03)] z-20">
                <button onclick="prevQuestion()" id="btn-prev" class="px-5 py-3 rounded-xl font-bold bg-gray-100 border border-gray-200 text-gray-700 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center">
                    <i class="fas fa-arrow-left md:mr-2"></i> <span class="hidden md:inline">Previous</span>
                </button>
                <button onclick="nextQuestion()" id="btn-next" class="px-8 py-3 rounded-xl font-bold bg-blue-600 text-white shadow-lg hover:bg-blue-700 hover:shadow-blue-500/30 transition flex items-center">
                    <span class="mr-2" id="next-text">Next</span> <i class="fas fa-arrow-right" id="next-icon"></i>
                </button>
            </div>
        </section>

        <!-- Sidebar / Grid Overlay (Mobile) -->
        <div id="grid-overlay" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-30 hidden md:hidden transition-opacity" onclick="toggleGrid()"></div>
        
        <aside id="sidebar-grid" class="fixed md:static inset-y-0 right-0 z-40 w-[85%] max-w-sm md:w-80 bg-white md:bg-gray-50 border-l border-gray-200 flex flex-col transform translate-x-full md:translate-x-0 transition-transform duration-300 shadow-2xl md:shadow-none h-full">
            <div class="p-5 border-b border-gray-100 bg-white flex justify-between items-center shrink-0">
                <h3 class="font-black text-gray-800 text-lg">Question Grid</h3>
                <button class="md:hidden w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200" onclick="toggleGrid()"><i class="fas fa-times"></i></button>
            </div>
            <div class="px-5 py-3 bg-white text-xs font-bold text-gray-500 flex space-x-4 border-b border-gray-100 shrink-0">
                <span class="flex items-center"><span class="w-3 h-3 bg-emerald-500 rounded-full mr-1.5 shadow-sm"></span> Answered</span>
                <span class="flex items-center"><span class="w-3 h-3 bg-white border-2 border-gray-300 rounded-full mr-1.5"></span> Pending</span>
            </div>
            <div class="p-4 overflow-y-auto flex-1 bg-gray-50/50">
                <div id="question-grid" class="grid grid-cols-5 gap-2.5"></div>
            </div>
            <div class="p-5 bg-white border-t border-gray-100 shrink-0">
                <button onclick="confirmSubmit()" class="w-full bg-red-500 hover:bg-red-600 text-white font-black py-4 rounded-xl shadow-lg hover:shadow-red-500/30 transition transform hover:-translate-y-0.5">
                    SUBMIT EXAM
                </button>
            </div>
        </aside>

        <!-- Mobile FAB for Grid -->
        <button id="fab-grid" onclick="toggleGrid()" class="md:hidden fixed bottom-24 right-5 bg-blue-800 text-white w-14 h-14 rounded-full shadow-2xl shadow-blue-900/50 z-20 flex items-center justify-center border-2 border-white focus:outline-none transition-transform hover:scale-105 active:scale-95">
            <i class="fas fa-th text-xl"></i>
        </button>
    </main>

    <!-- Result & AI Correction Screen -->
    <main id="result-screen" class="hidden flex-1 items-start justify-center p-4 md:p-8 overflow-y-auto fade-in">
        <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-10 max-w-3xl w-full text-center my-auto transition-all pb-12 border border-gray-100" id="result-summary-card">
            
            <div id="result-icon" class="w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl shadow-inner">
            </div>
            <h2 id="result-title" class="text-3xl md:text-4xl font-black mb-2 text-gray-900">Exam Completed</h2>
            <p class="text-gray-500 mb-8 font-medium">Candidate: <span id="res-name" class="text-gray-800 font-bold">Name</span></p>
            
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl p-6 md:p-8 mb-8 inline-block w-full max-w-sm border border-blue-200 shadow-sm">
                <div class="text-5xl md:text-6xl font-black text-blue-800 mb-2 drop-shadow-sm" id="score-display">0%</div>
                <div class="text-blue-900 font-semibold tracking-wide">Final Score: <span id="score-raw" class="font-black text-lg">0</span> / 70</div>
            </div>

            <div class="grid grid-cols-3 gap-3 md:gap-5 mb-10 max-w-lg mx-auto">
                <div class="bg-white p-3 md:p-4 rounded-xl border border-gray-200 shadow-sm">
                    <div class="text-emerald-500 text-2xl md:text-3xl font-black" id="stat-correct">0</div>
                    <div class="text-[10px] md:text-xs text-gray-500 uppercase font-bold tracking-wider mt-1">Correct</div>
                </div>
                <div class="bg-white p-3 md:p-4 rounded-xl border border-gray-200 shadow-sm">
                    <div class="text-red-500 text-2xl md:text-3xl font-black" id="stat-wrong">0</div>
                    <div class="text-[10px] md:text-xs text-gray-500 uppercase font-bold tracking-wider mt-1">Incorrect</div>
                </div>
                <div class="bg-white p-3 md:p-4 rounded-xl border border-gray-200 shadow-sm">
                    <div class="text-gray-400 text-2xl md:text-3xl font-black" id="stat-unanswered">0</div>
                    <div class="text-[10px] md:text-xs text-gray-500 uppercase font-bold tracking-wider mt-1">Missed</div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-center gap-4 border-t border-gray-100 pt-8">
                <button onclick="location.reload()" class="bg-white border-2 border-gray-800 text-gray-800 hover:bg-gray-800 hover:text-white font-bold py-3.5 px-8 rounded-xl transition duration-300 w-full md:w-auto">
                    <i class="fas fa-redo-alt mr-2"></i> Retake Exam
                </button>
                <button onclick="toggleCorrections()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 px-8 rounded-xl transition duration-300 w-full md:w-auto shadow-lg hover:shadow-blue-500/30">
                    <i class="fas fa-graduation-cap mr-2"></i> Review AI Explanations
                </button>
            </div>

            <!-- Detailed Explanations Section -->
            <div id="ai-corrections-section" class="hidden mt-12 text-left border-t-2 border-dashed border-gray-200 pt-10 pb-10 fade-in">
                <div class="flex flex-col md:flex-row items-start md:items-center gap-4 mb-8 bg-blue-50 p-6 rounded-2xl border border-blue-100">
                    <div class="bg-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center shrink-0 shadow-md">
                        <i class="fas fa-robot text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-black text-gray-900">Expert Tutor Review</h3>
                        <p class="text-blue-800 font-medium mt-1">Study the concepts below to master CHM 101. Pay attention to your mistakes.</p>
                    </div>
                </div>
                
                <div id="corrections-list" class="space-y-8"></div>
                
                <div class="mt-12 text-center">
                    <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-8 rounded-full transition">
                        <i class="fas fa-arrow-up mr-2"></i> Back to Top
                    </button>
                </div>
            </div>

        </div>
    </main>

    <!-- Submission Modal -->
    <div id="submit-modal" class="hidden fixed inset-0 bg-gray-900/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full mx-auto text-center transform scale-100 transition-transform">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="text-2xl font-black text-gray-900 mb-2">Submit Exam?</h3>
            <p class="text-gray-600 mb-8 font-medium">You still have <strong id="unanswered-count" class="text-red-600 font-black text-lg">0</strong> unanswered questions. Once submitted, you cannot return.</p>
            <div class="flex flex-col gap-3">
                <button onclick="submitExam()" class="w-full bg-red-500 text-white font-bold py-3.5 rounded-xl hover:bg-red-600 transition shadow-lg hover:shadow-red-500/30">Yes, Submit Now</button>
                <button onclick="closeModal()" class="w-full text-gray-600 font-bold py-3.5 rounded-xl hover:bg-gray-100 transition">Cancel & Return</button>
            </div>
        </div>
    </div>

    <!-- MAIN JAVASCRIPT LOGIC & DATABASE -->
    <script>
        // --- 1. JSON FETCH LOGIC (Reads your exact questions.json file!) ---
        let fullDatabase = [];
        
        // Fallback data just in case GitHub hasn't loaded the JSON yet
        const fallbackData = [
            { q: "What is a chemical reaction?", options: ["Interaction between reactants to produce a product.", "Separation of an element into atoms.", "Physical change of state.", "None of the above."], ans: 0, topic: "Atomic Theory", expl: "Reactants interact, breaking old bonds and forming new ones." }
        ];

        async function fetchQuestionsFromJSON() {
            try {
                // This connects directly to the questions.json you uploaded to your GitHub folder!
                const response = await fetch('./questions.json');
                
                if (!response.ok) throw new Error("Could not load questions.json");
                
                const data = await response.json();
                
                // Map your JSON letter answers to the JS engine index logic (0, 1, 2, 3)
                const letterToIndex = { 'A': 0, 'B': 1, 'C': 2, 'D': 3 };
                
                fullDatabase = data.all.map(q => ({
                    q: q.question,
                    options: [q.options.A, q.options.B, q.options.C, q.options.D],
                    ans: letterToIndex[q.correct_answer] !== undefined ? letterToIndex[q.correct_answer] : 0,
                    topic: q.topic || "General Chemistry",
                    expl: q.explanation || "No explanation provided in database."
                }));

                console.log(`Successfully parsed ${fullDatabase.length} questions from JSON!`);
                enableStartButton();

            } catch (error) {
                console.warn("Could not fetch questions.json. Using fallback data.", error);
                fullDatabase = fallbackData; 
                enableStartButton();
            }
        }

        function enableStartButton() {
            const btn = document.getElementById('start-exam-btn');
            const spinner = document.getElementById('loading-spinner');
            const btnText = document.getElementById('start-btn-text');
            if(btn) {
                btn.disabled = false;
                btn.classList.replace('bg-gray-400', 'bg-blue-600');
                btn.classList.add('hover:bg-blue-700', 'hover:-translate-y-1');
                if(spinner) spinner.classList.add('hidden');
                if(btnText) btnText.innerText = 'Start Examination';
            }
        }

        // --- 2. AUTHENTICATION & IP TRACKING ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load the questions from the JSON file immediately
            fetchQuestionsFromJSON();

            const userData = localStorage.getItem('chm101_user');
            if (userData) {
                const user = JSON.parse(userData);
                document.getElementById('dash-name').innerText = user.name;
                document.getElementById('dash-dept').innerText = user.dept;
                document.getElementById('res-name').innerText = user.name;
                document.getElementById('display-name').innerText = user.name.split(' ')[0];
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('start-screen').classList.replace('hidden', 'flex');
                document.getElementById('header-user-info').classList.replace('hidden', 'flex');
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('student-name').value.trim();
            const dept = document.getElementById('student-dept').value.trim();
            
            if(name && dept) {
                const user = { name, dept };
                localStorage.setItem('chm101_user', JSON.stringify(user));
                
                document.getElementById('dash-name').innerText = name;
                document.getElementById('dash-dept').innerText = dept;
                document.getElementById('res-name').innerText = name;
                document.getElementById('display-name').innerText = name.split(' ')[0];
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('start-screen').classList.replace('hidden', 'flex');
                document.getElementById('header-user-info').classList.replace('hidden', 'flex');
            }
        });

        function logout() {
            localStorage.removeItem('chm101_user');
            location.reload();
        }

        // --- 3. EXAM LOGIC ---
        const TOTAL_QUESTIONS = 70;
        const EXAM_DURATION = 40 * 60; // 40 minutes
        
        let examQuestions = [];
        let userAnswers = new Array(TOTAL_QUESTIONS).fill(null);
        let currentQuestionIndex = 0;
        let timerInterval;
        let timeLeft = EXAM_DURATION;

        function shuffleArray(array) {
            let arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function startExam() {
            if(fullDatabase.length === 0) return; // Prevent start if JSON isn't loaded

            let shuffledDB = shuffleArray(fullDatabase);
            // If the JSON somehow has less than 70 questions, repeat them to reach 70
            while(shuffledDB.length < TOTAL_QUESTIONS) {
                shuffledDB = shuffledDB.concat(shuffleArray(fullDatabase));
            }
            examQuestions = shuffledDB.slice(0, TOTAL_QUESTIONS);
            
            userAnswers = new Array(TOTAL_QUESTIONS).fill(null);
            currentQuestionIndex = 0;
            timeLeft = EXAM_DURATION;
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('exam-screen').classList.replace('hidden', 'flex');
            document.getElementById('timer-display').classList.remove('hidden');
            
            const fab = document.getElementById('fab-grid');
            if(fab) fab.classList.remove('hidden');
            
            buildQuestionGrid();
            renderQuestion(0);
            startTimer();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                const timerEl = document.getElementById('timer-display');
                
                if (timerEl) {
                    document.getElementById('time-left').innerText = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    if(timeLeft <= 300 && timeLeft > 0) { 
                        timerEl.classList.replace('text-blue-900', 'text-white');
                        timerEl.classList.remove('border-blue-200');
                        timerEl.classList.add('bg-red-600', 'border-red-600', 'animate-pulse');
                        const icon = timerEl.querySelector('i');
                        if(icon) icon.classList.replace('text-blue-500', 'text-white');
                    }
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitExam();
                }
            }, 1000);
        }

        function toggleGrid() {
            const sidebar = document.getElementById('sidebar-grid');
            const overlay = document.getElementById('grid-overlay');
            const fab = document.getElementById('fab-grid');
            
            if (!sidebar) return; 
            
            if(sidebar.classList.contains('translate-x-full')) {
                sidebar.classList.remove('translate-x-full');
                if (overlay) overlay.classList.remove('hidden');
                if (fab) fab.classList.add('opacity-0', 'pointer-events-none'); 
            } else {
                sidebar.classList.add('translate-x-full');
                if (overlay) overlay.classList.add('hidden');
                if (fab) fab.classList.remove('opacity-0', 'pointer-events-none'); 
            }
        }

        function buildQuestionGrid() {
            const grid = document.getElementById('question-grid');
            if (!grid) return;
            
            grid.innerHTML = '';
            for (let i = 0; i < TOTAL_QUESTIONS; i++) {
                const btn = document.createElement('button');
                btn.innerText = i + 1;
                btn.id = `grid-btn-${i}`;
                btn.className = `q-nav-btn w-full py-3 rounded-xl font-bold text-sm border-2 border-gray-200 bg-white text-gray-600 hover:bg-gray-100 hover:border-gray-300`;
                btn.onclick = () => {
                    renderQuestion(i);
                    if(window.innerWidth < 768) { toggleGrid(); }
                };
                grid.appendChild(btn);
            }
        }

        function renderQuestion(index) {
            currentQuestionIndex = index;
            const qData = examQuestions[index];
            
            const qNum = document.getElementById('current-q-num');
            const tBadge = document.getElementById('topic-badge');
            const qText = document.getElementById('question-text');
            const optionsContainer = document.getElementById('options-container');

            if (qNum) qNum.innerText = index + 1;
            if (tBadge) tBadge.innerText = qData.topic || "General Chemistry";
            if (qText) qText.innerText = qData.q;
            
            if (optionsContainer) {
                optionsContainer.innerHTML = '';
                
                const labels = ['A', 'B', 'C', 'D'];
                qData.options.forEach((opt, idx) => {
                    const isSelected = userAnswers[index] === idx;
                    
                    const optDiv = document.createElement('div');
                    optDiv.className = `flex items-center p-4 md:p-5 border-2 rounded-2xl cursor-pointer transition-all duration-200 group ${isSelected ? 'border-blue-500 bg-blue-50/50 shadow-[0_4px_12px_rgba(59,130,246,0.1)] transform scale-[1.01]' : 'border-gray-200 hover:border-blue-300 hover:bg-gray-50'}`;
                    optDiv.onclick = () => selectOption(idx);
                    
                    const circle = document.createElement('div');
                    circle.className = `w-8 h-8 md:w-10 md:h-10 rounded-full border-2 flex items-center justify-center font-bold mr-4 transition-colors shrink-0 text-sm md:text-base ${isSelected ? 'bg-blue-600 border-blue-600 text-white' : 'border-gray-300 text-gray-500 group-hover:border-blue-400 group-hover:text-blue-500'}`;
                    circle.innerText = labels[idx];
                    
                    const text = document.createElement('span');
                    text.className = `flex-1 text-base md:text-lg ${isSelected ? 'text-blue-900 font-bold' : 'text-gray-700 font-medium'}`;
                    text.innerText = opt;
                    
                    optDiv.appendChild(circle);
                    optDiv.appendChild(text);
                    optionsContainer.appendChild(optDiv);
                });
            }

            const btnPrev = document.getElementById('btn-prev');
            if (btnPrev) btnPrev.disabled = index === 0;
            
            const nextBtn = document.getElementById('btn-next');
            const nextText = document.getElementById('next-text');
            const nextIcon = document.getElementById('next-icon');
            
            if(nextBtn && nextText && nextIcon) {
                if(index === TOTAL_QUESTIONS - 1) {
                    nextText.innerText = 'Finish Attempt';
                    nextIcon.className = 'fas fa-flag-checkered';
                    nextBtn.onclick = confirmSubmit;
                    nextBtn.classList.replace('bg-blue-600', 'bg-emerald-500');
                    nextBtn.classList.replace('hover:bg-blue-700', 'hover:bg-emerald-600');
                    nextBtn.classList.replace('hover:shadow-blue-500/30', 'hover:shadow-emerald-500/30');
                } else {
                    nextText.innerText = 'Next Question';
                    nextIcon.className = 'fas fa-arrow-right';
                    nextBtn.onclick = nextQuestion;
                    nextBtn.classList.contains('bg-emerald-500') && nextBtn.classList.replace('bg-emerald-500', 'bg-blue-600');
                    nextBtn.classList.contains('hover:bg-emerald-600') && nextBtn.classList.replace('hover:bg-emerald-600', 'hover:bg-blue-700');
                    nextBtn.classList.contains('hover:shadow-emerald-500/30') && nextBtn.classList.replace('hover:shadow-emerald-500/30', 'hover:shadow-blue-500/30');
                }
            }

            updateGridUI();
        }

        function selectOption(optIndex) {
            userAnswers[currentQuestionIndex] = optIndex;
            renderQuestion(currentQuestionIndex);
            
            // Auto advance on desktop, manual on mobile to prevent accidental skips
            if(window.innerWidth >= 768 && currentQuestionIndex < TOTAL_QUESTIONS - 1) {
                setTimeout(nextQuestion, 300);
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < TOTAL_QUESTIONS - 1) renderQuestion(currentQuestionIndex + 1);
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) renderQuestion(currentQuestionIndex - 1);
        }

        function updateGridUI() {
            for (let i = 0; i < TOTAL_QUESTIONS; i++) {
                const btn = document.getElementById(`grid-btn-${i}`);
                if (!btn) continue;
                
                btn.classList.remove('active', 'answered');
                
                if (i === currentQuestionIndex) {
                    btn.classList.add('active');
                } else if (userAnswers[i] !== null) {
                    btn.classList.add('answered');
                }
            }
        }

        function confirmSubmit() {
            const unanswered = userAnswers.filter(a => a === null).length;
            const countEl = document.getElementById('unanswered-count');
            if (countEl) countEl.innerText = unanswered;
            
            const modal = document.getElementById('submit-modal');
            if (modal) modal.classList.remove('hidden');
        }

        function closeModal() {
            const modal = document.getElementById('submit-modal');
            if (modal) modal.classList.add('hidden');
        }

        function submitExam() {
            clearInterval(timerInterval);
            closeModal();
            
            // 1. Ensure sidebar is toggled closed properly BEFORE removing elements to prevent JS errors
            const sidebar = document.getElementById('sidebar-grid');
            if(sidebar && !sidebar.classList.contains('translate-x-full')) {
                toggleGrid();
            }

            // 2. Safely hide the FAB
            const fab = document.getElementById('fab-grid');
            if(fab) fab.classList.add('hidden'); 
            
            let score = 0;
            let answered = 0;
            
            for (let i = 0; i < TOTAL_QUESTIONS; i++) {
                if (userAnswers[i] !== null) {
                    answered++;
                    if (userAnswers[i] === examQuestions[i].ans) score++;
                }
            }

            const percentage = Math.round((score / TOTAL_QUESTIONS) * 100);
            const wrong = answered - score;
            const unanswered = TOTAL_QUESTIONS - answered;

            const examScreen = document.getElementById('exam-screen');
            if(examScreen) examScreen.classList.add('hidden'); 
            
            const timerDisplay = document.getElementById('timer-display');
            if(timerDisplay) timerDisplay.classList.add('hidden');
            
            const headerUserInfo = document.getElementById('header-user-info');
            if(headerUserInfo) headerUserInfo.classList.add('hidden');
            
            const resultScreen = document.getElementById('result-screen');
            if(resultScreen) resultScreen.classList.replace('hidden', 'flex');

            const scoreDisplay = document.getElementById('score-display');
            if (scoreDisplay) scoreDisplay.innerText = `${percentage}%`;
            
            const scoreRaw = document.getElementById('score-raw');
            if (scoreRaw) scoreRaw.innerText = score;
            
            const statCorrect = document.getElementById('stat-correct');
            if (statCorrect) statCorrect.innerText = score;
            
            const statWrong = document.getElementById('stat-wrong');
            if (statWrong) statWrong.innerText = wrong;
            
            const statUnanswered = document.getElementById('stat-unanswered');
            if (statUnanswered) statUnanswered.innerText = unanswered;

            const iconContainer = document.getElementById('result-icon');
            const title = document.getElementById('result-title');
            
            if (percentage >= 70) {
                if (iconContainer) {
                    iconContainer.className = "w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl bg-emerald-100 text-emerald-500 shadow-inner";
                    iconContainer.innerHTML = '<i class="fas fa-trophy"></i>';
                }
                if (title) title.innerText = "Excellent Job!";
            } else if (percentage >= 50) {
                if (iconContainer) {
                    iconContainer.className = "w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl bg-blue-100 text-blue-500 shadow-inner";
                    iconContainer.innerHTML = '<i class="fas fa-thumbs-up"></i>';
                }
                if (title) title.innerText = "Solid Effort!";
            } else {
                if (iconContainer) {
                    iconContainer.className = "w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl bg-orange-100 text-orange-500 shadow-inner";
                    iconContainer.innerHTML = '<i class="fas fa-book-reader"></i>';
                }
                if (title) title.innerText = "Keep Studying!";
            }
        }

        function toggleCorrections() {
            const aiSection = document.getElementById('ai-corrections-section');
            const resultCard = document.getElementById('result-summary-card');
            const listContainer = document.getElementById('corrections-list');
            
            if (!aiSection || !resultCard || !listContainer) return;
            
            if (aiSection.classList.contains('hidden')) {
                resultCard.classList.remove('max-w-3xl');
                resultCard.classList.add('max-w-4xl');
                aiSection.classList.remove('hidden');
                
                listContainer.innerHTML = '';
                
                examQuestions.forEach((qData, index) => {
                    const userAnsIdx = userAnswers[index];
                    const correctAnsIdx = qData.ans;
                    const isCorrect = userAnsIdx === correctAnsIdx;
                    
                    const cardDiv = document.createElement('div');
                    cardDiv.className = `p-6 rounded-2xl border-l-8 shadow-sm ${isCorrect ? 'border-emerald-500 bg-white' : 'border-red-500 bg-white'}`;
                    
                    let userAnsText = userAnsIdx !== null ? qData.options[userAnsIdx] : "<em>No Answer Selected</em>";
                    let correctAnsText = qData.options[correctAnsIdx];
                    
                    const headerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <span class="font-black text-gray-900 text-lg">Question ${index + 1}</span>
                            <span class="text-[10px] uppercase font-black px-3 py-1 rounded bg-gray-100 text-gray-500 tracking-wider">${qData.topic}</span>
                        </div>
                        <p class="text-gray-800 font-medium text-lg mb-5">${qData.q}</p>
                    `;
                    
                    let bodyHTML = '';
                    if(isCorrect) {
                        bodyHTML = `
                            <div class="flex items-center text-emerald-800 bg-emerald-50 p-4 rounded-xl border border-emerald-100 mb-4">
                                <i class="fas fa-check-circle mr-3 text-2xl text-emerald-500"></i>
                                <div>
                                    <span class="block text-[10px] uppercase font-black text-emerald-600 mb-0.5 tracking-wider">Your Answer (Correct)</span>
                                    <span class="font-semibold">${userAnsText}</span>
                                </div>
                            </div>
                        `;
                    } else {
                        bodyHTML = `
                            <div class="space-y-3 mb-4">
                                <div class="flex items-center text-red-800 bg-red-50 p-4 rounded-xl border border-red-100">
                                    <i class="fas fa-times-circle mr-3 text-2xl text-red-500"></i>
                                    <div>
                                        <span class="block text-[10px] uppercase font-black text-red-600 mb-0.5 tracking-wider">Your Answer</span>
                                        <span class="font-semibold">${userAnsText}</span>
                                    </div>
                                </div>
                                <div class="flex items-center text-emerald-800 bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                                    <i class="fas fa-check-circle mr-3 text-2xl text-emerald-500"></i>
                                    <div>
                                        <span class="block text-[10px] uppercase font-black text-emerald-600 mb-0.5 tracking-wider">Correct Answer</span>
                                        <span class="font-semibold">${correctAnsText}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    const explanationHTML = `
                        <div class="text-sm text-blue-900 bg-blue-50/80 p-5 rounded-xl border border-blue-100 mt-2 flex items-start">
                            <i class="fas fa-graduation-cap text-blue-600 text-xl mr-4 mt-0.5"></i>
                            <div>
                                <strong class="block text-blue-800 mb-1.5 uppercase text-[10px] tracking-widest font-black">Expert Tutor Explanation:</strong>
                                <span class="leading-relaxed font-medium">${qData.expl}</span>
                            </div>
                        </div>
                    `;
                    
                    cardDiv.innerHTML = headerHTML + bodyHTML + explanationHTML;
                    listContainer.appendChild(cardDiv);
                });
                
                setTimeout(() => { aiSection.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 150);
            } else {
                aiSection.classList.add('hidden');
                resultCard.classList.remove('max-w-4xl');
                resultCard.classList.add('max-w-3xl');
            }
        }
    </script>
</body>
</html>